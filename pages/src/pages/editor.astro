---
import {
  Swell,
  SwellTheme,
  getEditorLanguageConfig,
  removeCircularReferences,
} from '@swell/storefrontjs';
import EasyblocksEditor from '@/components/EasyblocksEditor.jsx';
import storefrontConfig from '../../storefront.json';
import StorefrontShopifyCompatibility from '@/resources/shopify-compatibility';

const initialPageId = 'index';

// Editor requires rootComponent param
if (!Astro.url.searchParams.get('rootTemplate')) {
  return Astro.redirect(`/editor?rootTemplate=page_${initialPageId}`);
}

const swell = new Swell({ serverHeaders: Astro.request.headers });
const theme = new SwellTheme(swell, {
  storefrontConfig,
  shopifyCompatibilityClass: StorefrontShopifyCompatibility,
});

await theme.initGlobals({ pageId: initialPageId, url: Astro.url });

const sectionGroup = (await theme.renderPageTemplate(
  initialPageId
)) as unknown as ThemeSectionGroup;

if (!sectionGroup) {
  return Astro.redirect(`/404`);
}

let [sectionConfigs, pageSections, layoutSectionGroups, editorLang] =
  await Promise.all([
    theme.getSectionGroupConfigs(sectionGroup),
    theme.getPageSections(),
    theme.getLayoutSectionGroups(),
    getEditorLanguageConfig(swell),
  ]);

sectionConfigs = removeCircularReferences(sectionConfigs);
pageSections = removeCircularReferences(pageSections);
layoutSectionGroups = removeCircularReferences(layoutSectionGroups);
---

<html lang="en">
  <head>
    <title>Swell Theme Editor</title>
  </head>
  <body style={{ margin: 0, padding: 0 }}>
    {
      (
        <EasyblocksEditor
          pageId={initialPageId}
          pageSections={pageSections}
          layoutSectionGroups={layoutSectionGroups}
          sectionConfigs={sectionConfigs}
          lang={editorLang}
          client:only="react"
        />
      )
    }
  </body>
</html>
