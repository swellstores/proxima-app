---
import _ from 'lodash';
import Layout from '../../../layouts/Layout.astro';
import { Swell } from "../../../swell/api";
import { getContentModel, getContentEntry } from "../../../swell/content";
import { SwellTheme } from "../../../swell/theme";

const swell = new Swell(Astro);
const theme = new SwellTheme(swell);

await theme.init(Astro, 'content/entry');

const { content_slug, entry_slug } = Astro.params;
const [ model, entry ] = await Promise.all([
  getContentModel(swell, content_slug),
  getContentEntry(swell, content_slug, entry_slug, theme.page?.query)
]);

let title, description, content;

if (model && entry) {
	title = _.get(entry, model.storefront.title_field) || entry.id;
	description = _.get(entry, model.storefront.description_field)
	[ content ] = await Promise.all([
		theme.renderPage({ entry }, entry.theme_template)
	]);
} else {
	title = 'Page not found';
	content = await theme.renderPageTemplate('404');
}
---

<Layout theme={theme} page_title={title} page_description={description}>
	<div slot="content_for_layout" set:html={content} />
</Layout>
