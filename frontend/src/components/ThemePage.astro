---
import get from 'lodash/get';
import { initSwell, initTheme } from '@/swell';
import {
  Swell,
  PageError,
  PageNotFound,
  SwellTheme,
} from '@swell/storefront-sdk';
import Layout from '@/layouts/Layout.astro';
import ThemeSections from './ThemeSections.astro';
import EditorPage from './EditorPage.astro';
import ErrorPage from './ErrorPage.astro';

const sections = Astro.url.searchParams.get('sections');
const sectionId = Astro.url.searchParams.get('section_id');
const sectionIds = sections
  ? sections.split(',')
  : sectionId
    ? [sectionId]
    : null;

export interface Props {
  id: string;
  title?: string | ((data: SwellData | undefined) => string);
  description?: string | ((data: SwellData | undefined) => string);
  required?: string;
  requiredPath?: string;
  content?: string;
  props?: {
    [key: string]: any;
  };
  easyblocks?: boolean;
  getData?: (swell: Swell, theme: SwellTheme) => Promise<SwellData> | SwellData;
}

const { id, title, description, required, content, props, getData } =
  Astro.props;

const swell = Astro.locals.swell || initSwell(Astro);

// Indicate response was sent to avoid mutating cookies
if (Astro.locals.swell) {
  swell.sentResponse = true;
}

const theme = Astro.locals.theme || initTheme(swell);

if (!theme.pageId) {
  await theme.initGlobals(id);
}

const isEditor = typeof Astro.url.searchParams.get('_editor') === 'string';

let pageData, pageTitle, pageDescription, pageContent, pageError;

try {
  // Rendering page content
  pageData = getData && (await getData(swell, theme));

  theme.setCompatibilityData(pageData);

  [pageTitle, pageDescription, pageContent] = await Promise.all([
    typeof title === 'string'
      ? await theme.renderTemplateString(title, pageData)
      : typeof title === 'function'
        ? await title(pageData)
        : '',

    typeof description === 'string'
      ? await theme.renderTemplateString(description, pageData)
      : typeof description === 'function'
        ? await description(pageData)
        : '',

    content ?? sectionIds
      ? theme.renderAllSections(sectionIds, {
          ...props,
          ...pageData,
        })
      : theme.renderPage(
          {
            ...props,
            ...pageData,
          },
          pageData?.theme_template
        ),
  ]);

  // TODO: replace with json schema validation
  if (typeof pageContent !== 'string' && !pageContent) {
    throw new PageError('Invalid page content');
  }

  if (!pageTitle && pageContent?.page?.title) {
    pageTitle = pageContent.page.title;
  }
  if (!pageDescription && pageContent?.page?.description) {
    pageDescription = pageContent.page.description;
  }

  if (required) {
    const isFound = await get(pageData, required);
    if (!isFound) {
      throw new PageNotFound();
    }
  }
} catch (err: any) {
  try {
    if (err instanceof PageNotFound) {
      try {
        pageTitle = err.message;
        pageContent = await theme.renderPageTemplate('404');
      } catch (renderErr: any) {
        throw err;
      }
    } else {
      throw err;
    }
  } catch {
    console.error(err);
    pageError = {
      title: err.title,
      status: err.status,
      description: swell.isPreview ? err.description || err.message : undefined,
    };
  }
}

const pageProps = { ...props, ...pageData };
const layoutProps = {
  page_title: pageTitle || pageData?.title || theme.globals.store?.name,
  page_description: pageDescription || pageData?.description,
  content_for_header: theme.getContentForHeader(),
  props,
};
---

{
  pageError ? (
    <ErrorPage {...pageError} />
  ) : sections ? (
    JSON.stringify(pageContent)
  ) : sectionId ? (
    <Fragment set:html={pageContent[sectionId]} />
  ) : isEditor ? (
    <html>
      <EditorPage
        swell={swell}
        theme={theme}
        pageProps={pageProps}
        pageContent={pageContent}
        layoutProps={layoutProps}
      />
    </html>
  ) : (
    <Layout theme={theme} {...layoutProps}>
      <Fragment slot="content_for_layout">
        {typeof pageContent === 'string' ? (
          <Fragment set:html={pageContent} />
        ) : (
          <ThemeSections theme={theme} content={pageContent} data={pageProps} />
        )}
      </Fragment>
    </Layout>
  )
}
