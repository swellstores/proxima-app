---
import get from 'lodash/get';

import {
  PageError,
  PageNotFound,
  type Swell,
  type SwellTheme,
  type SwellData,
  type ThemeSectionGroup,
  type ThemeGlobals,
} from '@swell/apps-sdk';

import { initSwellTheme } from '@/swell';
import { isTemplateConfig, isPageContentRecord } from '@/utils/types-guard';
import Layout from '@/layouts/Layout.astro';

import ThemeSections from './ThemeSections.astro';
import ErrorPage from './ErrorPage.astro';

interface Props {
  id: string;
  title?: string;
  description?: string;
  required?: string;
  content?: string;
  props?: Record<string, unknown>;
  getData?(swell: Swell, theme: SwellTheme): Promise<SwellData> | SwellData;
}

let altTemplate = Astro.url.searchParams.get('view') ?? undefined;
const sections = Astro.url.searchParams.get('sections');
const sectionId = Astro.url.searchParams.get('section_id');
const sectionIds = sections
  ? sections.split(',')
  : sectionId
    ? [sectionId]
    : null;

const { id, title, description, required, content, props, getData } =
  Astro.props;

const { swell, theme } = await initSwellTheme(Astro);

let pageData, pageContent, pageRecord, pageError, pageOverrides: Record<string, unknown> = {};

try {
  // Rendering page content
  pageData = getData && (await getData(swell, theme));

  if (required) {
    const isFound = await get(pageData, required);

    if (!isFound) {
      throw new PageNotFound();
    }
  }

  const page = theme.props.pages.find((page) => page.id === id);

  if (page?.record) {
    pageRecord = get(pageData, page.record);

    if (typeof altTemplate !== 'string') {
      altTemplate = await get(pageRecord, 'theme_template');
    }
  }

  theme.globals = {} as unknown as ThemeGlobals;
  await theme.initGlobals(id, { pageRecord, altTemplate });

  if (pageData) {
    theme.setCompatibilityData(pageData);
  }

  pageContent = await ((content ?? sectionIds)
      ? theme.renderAllSections(sectionIds ?? [], {
          ...props,
          ...pageData,
        })
      : theme.renderPage(
          {
            ...props,
            ...pageData,
          },
          altTemplate,
        )
  );

  // TODO: replace with json schema validation
  if (typeof pageContent !== 'string' && !pageContent) {
    throw new PageError('Invalid page content');
  }

  if (isTemplateConfig(pageContent)) {
    if (!title && pageContent.page?.title) {
      pageOverrides.page_title = pageContent.page.title;
    }

    if (!description && pageContent.page?.description) {
      pageOverrides.description = pageContent.page.description;
    }
  }
} catch (err: any) {
  try {
    if (err instanceof PageNotFound) {
      try {
        pageOverrides.page_title = err.message;
        pageContent = await theme.renderPageTemplate('404');
      } catch (renderErr: any) {
        throw err;
      }
    } else {
      throw err;
    }
  } catch {
    console.error(err);
    pageError = {
      title: err.title,
      status: err.status,
      description: swell.isPreview ? err.description || err.message : undefined,
    };
  }
}

const pageProps = { ...props, ...pageData };

const layoutName = typeof pageContent === 'object'
  ? (pageContent as any)?.layout
  : undefined;

const layoutProps = {
  page_title: title,
  page_description: description,
  ...props,
  ...pageOverrides,
};
---

{
  pageError ? (
    <ErrorPage {...pageError} />
  ) : sections ? (
    JSON.stringify(pageContent)
  ) : (sectionId && isPageContentRecord(pageContent, sectionId)) ? (
    <Fragment set:html={pageContent[sectionId]} />
  ) : (
    <Layout layout={layoutName} theme={theme} props={layoutProps}>
      <Fragment slot="content_for_layout">
        {isTemplateConfig(pageContent) ? (
          <ThemeSections theme={theme} content={pageContent as ThemeSectionGroup} data={pageProps} />
        ) : theme.isShopify1HomePage(id, pageContent) ? (
          <Fragment set:html={theme.renderShopify1HomePage(pageContent)} />
        ) : (
          <Fragment set:html={pageContent} />
        )}
      </Fragment>
    </Layout>
  )
}
